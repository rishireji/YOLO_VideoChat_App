rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    match /Users/{userId} {
      // 1. Profile Visibility: Public profiles are restricted. 
      // Full read only if owner OR reciprocal friend.
      allow read: if request.auth != null && (
        request.auth.uid == userId || 
        exists(/databases/$(database)/documents/Users/$(userId)/friends/$(request.auth.uid))
      );
      
      // 2. Profile Modification: Owner only
      allow write: if request.auth != null && request.auth.uid == userId;
      
      // 3. Handshake Outbound: Owner manages their own dispatched handshakes
      match /sentRequests/{requestId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
      
      // 4. Handshake Inbound: 
      // Create: Allowed by any authenticated user IF the document ID matches their own UID
      // Read/Delete: Recipient (userId) only
      match /receivedRequests/{senderId} {
        allow create: if request.auth != null && request.auth.uid == senderId;
        allow read, delete: if request.auth != null && request.auth.uid == userId;
      }

      // 5. Vault Access: Strictly owner only
      match /files/{fileId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
      
      // 6. Reciprocal Friendship: Read/Write if involved in the handshake
      match /friends/{friendId} {
        allow read: if request.auth != null && (request.auth.uid == userId || request.auth.uid == friendId);
        allow write: if request.auth != null && (request.auth.uid == userId || request.auth.uid == friendId);
        allow delete: if request.auth != null && (request.auth.uid == userId || request.auth.uid == friendId);
      }
    }
    
    // Strict Global Deny
    match /{document=**} {
      allow read, write: if false;
    }
  }
}